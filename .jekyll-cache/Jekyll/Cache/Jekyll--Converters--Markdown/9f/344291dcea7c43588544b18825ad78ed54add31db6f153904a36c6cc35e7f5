I"ù"<h2 id="creating-raster-tiles">Creating Raster Tiles</h2>

<h2 id="preferred-method">Preferred Method</h2>

<h3 id="using-qgis--generate-xyz-tiles">Using QGIS &amp; Generate XYZ Tiles</h3>

<ol>
  <li>Georeference and Export the raster using the Web Mercator 3857 Projection (256 for No DATA) in ArcMap or ArcPro using ITRF00 transformation. QGIS is missing the ITRF00 transformation. It is hardcoded into PostGIS but not in QGIS, which is why we use Arc* here.</li>
  <li>Load the raster into QGIS</li>
  <li>Change the zoomed in sampling to Average and any other settings under properties</li>
  <li>Export to raster tiles using the Generate XYZ tiles tool</li>
  <li>See the screenshot with settings - all defaut except make sure to use the extent of the raster layer
 a. Use maxzoom 16 for old paper maps, 20 for satellite  imagery</li>
  <li>Use the  node script to add the image layers to the dataIndex.json
 a. ‚ÄúC:_Master_GIS\GIS_Applications\production\sde-backup-vector-tile-cache\src\createJsonForRasterTiles.js‚Äù</li>
</ol>

<p><img src="/assets/img/generate_xyz_tiles.jpg" alt="" /></p>

<hr />

<h2 id="other-methods">Other Methods</h2>

<h3 id="using-gdal2tilesppy">Using gdal2tilesp.py</h3>

<p>Reproject the original image to EPSG:3857 using gdalwarp. Use all the same options as before expcept use a higher compression. <strong>This needs to be checked to make sure that the geographic transformation is happening correctly.</strong> <em>This might not make that much difference if using JPG tiles as final output.</em></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nx">gdalwarp</span> <span class="o">-</span><span class="k">of</span> <span class="nx">GeoTIFF</span> <span class="o">-</span><span class="nx">co</span> <span class="nx">COMPRESS</span><span class="o">=</span><span class="nx">JPEG</span> <span class="o">-</span><span class="nx">co</span> <span class="nx">JPEG_QUALITY</span><span class="o">=</span><span class="mi">60</span> <span class="p">...</span>
</code></pre></div></div>

<p>Use the customized gdal2tilesp.py python script to cut the tif into a folder of raster tiles for use in web mapping. There are similar scripts that will output to mbtiles or geopackage. This script was originally written by the developer of <a href="https://www.maptiler.com/">MapTiler</a>. The gdal2tiles that is built in to gdal only outputs images in png format and <strong>does not use parallel processing</strong>. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the <code class="language-plaintext highlighter-rouge">--processes</code> to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">gdal2tilesp</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">f</span> <span class="n">JPEG</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">z</span> <span class="mi">0</span><span class="o">-</span><span class="mi">20</span> <span class="o">--</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span> <span class="nb">input</span><span class="p">.</span><span class="n">tif</span> <span class="n">outputFolder</span>
</code></pre></div></div>

<p><em>JPEG results in smaller files but looses the transparency.</em></p>

<p><strong>30GB .sid file =&gt; 6.56GB tif (JPG_QUALITY 50% using gdalwarp) =&gt; 15 GB raster tiles (PNG)</strong>
<strong>30GB .sid file =&gt; 6.56GB tif (JPG_QUALITY 50% using gdalwarp) =&gt; 4 GB raster tiles (JPG)</strong></p>

<h4 id="references">References</h4>
<ul>
  <li><a href="https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/">https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/</a></li>
  <li><a href="https://github.com/pramsey/gdal2tilesp">https://github.com/pramsey/gdal2tilesp</a></li>
  <li><a href="https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/">https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/</a></li>
</ul>

<h3 id="using-gdal_gdaladdo">Using gdal_gdaladdo</h3>

<p>Use gdal_translate to generate the mbtiles file</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdal_translate -of mbtiles mymap.tif mymap.mbtiles
</code></pre></div></div>

<p>Use gdal_gdaladdo to generate the rest of the tiles (overview tiles)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdaladdo -r nearest mymap.mbtiles 2 4 8 16
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- this results in tiles from z levels??
</code></pre></div></div>

<p>Unpack the mbiles to folders using <a href="https://github.com/mapbox/mbutil">mbutil</a> which is a python script, run it using cmd.exe in its own folder like this:
	<code class="language-plaintext highlighter-rouge">python mb-util</code></p>

<h2 id="clipping-and-resizing-using-gdal-or-qgis">Clipping and Resizing using GDAL or QGIS</h2>

<p><strong>Two images will be created, one in the original projection Ohio SP South - EPSG:3735 with a JPEG quality of 75. This one is for desktop GIS use. The second image will be in Web Mercator EPSG:3857, with a JPEG quality between 50 and 60, which will be used to create the image tile cache for web applications.</strong> <em>This may not matter if using JPEG for the final output raster tiles.</em></p>

<p>Saving using LZW or DEFLATE resulted in a very large tif. Using <code class="language-plaintext highlighter-rouge">-co compression=JPEG -co JPEG_QUALITY=75</code> results in great image quality in a much smaller file. Settings used:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-multi 			// Uses two processes to manipulate the images
-wo			// DOES NOT SEEM TO BE WORKING Total number of CPUs for calculations
-cutline		// Shapefile to clip the polygon referenced with the full file path in quotes
-crop_to_cutline	// Clip the raster using the cutline polygon 
-co			// Compression used and options
-dstalpha		// Use an Alpha layer to store transparency - the original channel is used if none is provided elsewhere

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdalwarp -multi -wo NUM_THREADS=8 -of GTiff -cutline E:\ortho18\clip-coz.shp -crop_to_cutline -dstalpha -co COMPRESS=JPEG -co JPEG_QUALITY=75 "E:/ortho18/Area Wide Mosaics/OHMUSK18-SID-3INCH/OHMUSK18-SID-3INCH.sid" E:/ortho18/qgis-testing/OHMUSK18_3IN_GDALWARP_CLIP_JPG75_ALPHA.tif
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdalwarp -wo NUM_THREADS=ALL_CPUS -multi -of GTiff -cutline E:\ortho18\clip-coz.shp -crop_to_cutline -dstalpha -co COMPRESS=JPEG -co JPEG_QUALITY=75 -co TILED=yes -co BIGTIFF=YES "E:/ortho18/Area Wide Mosaics/OHMUSK18-SID-3INCH/OHMUSK18-SID-3INCH.sid" E:/ortho18/qgis-testing/OHMUSK18_3IN_GDALWARP_CLIP_JPG75_ALPHA_BIGTIFF.tif
</code></pre></div></div>

<p>If an error comes up about the size being too large try adding these settings -</p>

<p><code class="language-plaintext highlighter-rouge">-co TILED=yes -co BLOCKXSIZE=256 -co BLOCKYSIZE=256</code> - <strong>started task at 11:30 on march 26th</strong></p>

<h4 id="references-1">References</h4>

<p><a href="https://www.gdal.org/frmt_gtiff.html">https://www.gdal.org/frmt_gtiff.html</a></p>

<p><a href="https://www.gdal.org/gdalwarp.html">https://www.gdal.org/gdalwarp.html</a></p>

<p><a href="https://github.com/dwtkns/gdal-cheat-sheet">https://github.com/dwtkns/gdal-cheat-sheet</a></p>

<p><a href="https://www.azavea.com/blog/2018/10/11/creating-leaflet-tiles-from-open-data/">https://www.azavea.com/blog/2018/10/11/creating-leaflet-tiles-from-open-data/</a></p>

<p><a href="http://www.thesjg.com/2013/03/generating-aerial-tiles-from-naip-imagery/">http://www.thesjg.com/2013/03/generating-aerial-tiles-from-naip-imagery/</a></p>

<p><a href="https://gis.stackexchange.com/questions/104453/why-result-of-merge-of-multiple-raster-is-so-big">https://gis.stackexchange.com/questions/104453/why-result-of-merge-of-multiple-raster-is-so-big</a></p>

<p><a href="http://docs.geonode.org/en/master/tutorials/advanced/adv_data_mgmt/adv_raster/processing.html">http://docs.geonode.org/en/master/tutorials/advanced/adv_data_mgmt/adv_raster/processing.html</a></p>
:ET