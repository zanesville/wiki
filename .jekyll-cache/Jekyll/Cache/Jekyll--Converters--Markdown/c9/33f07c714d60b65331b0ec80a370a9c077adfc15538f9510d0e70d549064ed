I"^<h2 id="intro">Intro</h2>

<p>The main city web maps and a handful of apps are (mostly) hosted on Netlify, powered by Mapbox GL JS, and are built with NodeJS. The main build tools are parcel-bundler, Gulp and the static site generator Hexo. The data is a combination of raster and vector tiles and raw GeoJSON data. The raster tiles are created using QGIS export xyz tiles from a raster <em>already in WGS84</em>. The vector tiles and GeoJSON data is created using the process below.</p>

<blockquote>
  <p>The web maps could all be ported over to ArcGIS Online or the AGOL CMV, but those tools lack some of the functionality in the custom maps.</p>
</blockquote>

<p>The JavaScript that powers the map controls such as the layer control and network trace control is a custom-built library. This library is bundled using parcel-bundler. The files should be self-explanatory but could be broken out even further into individual components.</p>

<h2 id="arcgis-online">ArcGIS Online</h2>

<p>A few maps and layers are hosted on AGOL. Several Survey123 apps are hosted here, mainly for field inspections.</p>

<h2 id="311cozorg">311.coz.org</h2>

<p>This is a Windows IIS Server managed by IT that houses our GIS database, static files for the web maps including raster tiles, vector tiles, and attachments, as well as a NodeJS Fastify server for a handful of custom built CRUD apps. These Node apps talk directly to the GIS database.</p>

<h2 id="giscozorg">gis.coz.org</h2>

<p>HexoJS (NodeJS) static site hosted on Netlify. Contains the majority of our web maps. More information below.</p>

<h3 id="creating-the-vector-tile-cache">Creating the Vector Tile Cache</h3>

<p>This is done with a script that runs nightly as a scheduled task on the 311 server. It is located at <code class="language-plaintext highlighter-rouge">\geospatial-applications\node_applications\production\gis-data-vector-tile-cache</code>. This script does the following:</p>

<ol>
  <li>Spins up a simple Node server to serve out GeoJSON endpoints of all data in the Postgres database with user “viewer” select privledges.</li>
  <li>Downloads a layer list.</li>
  <li>Appends the layer list with the timestamp for the last edited date of the layer.</li>
  <li>Compares the timestamp to a cached layer list - saved as a json file in the same folder as the script.</li>
  <li>Downloads any changed files as GeoJSON.</li>
  <li>Compares these files to the GeoJSON files on the 311 server.</li>
  <li>If new, adds a unique ID to the file, creates a centroid label layer if it is a polygon, and overwrites the 311 GeoJSON cache with these files.</li>
  <li>Creates a vector tile cache on the 311 server using a modified version of <code class="language-plaintext highlighter-rouge">geojson2mvt</code>.</li>
  <li>An available layers list is updated on the 311 server as is the layerCacheList.json in the script folder.</li>
</ol>

<blockquote>
  <p>Some large files, such as the <code class="language-plaintext highlighter-rouge">env_contours_10ft_simplified</code> are too large to be cached using this script. The vector tiles for any large files such as these were created by first exposting the geojson from QGIS then using the <code class="language-plaintext highlighter-rouge">vtile</code> script directly on the file, increasing the Node memory limit with <code class="language-plaintext highlighter-rouge">node --max_old_space_size=16384 vtile -f filename -Z 16</code></p>
</blockquote>

<h3 id="software--building">Software &amp; Building</h3>
<p>NodeJS needs to be installed to build and deploy this website.</p>

<p>Major Dependencies</p>
<ul>
  <li>Parcel - installed globally</li>
  <li>Hexo</li>
  <li>Gulp - installed globally</li>
</ul>

<p>The site, besides the static vector tiles, raster tiles, and data attachments (PDFs, asset images, etc) is hosted on Netlify, with the other files hosted on the 311 server. Use netlify-cli command-line tools to deploy to Netlify, this is taken care of in the <code class="language-plaintext highlighter-rouge">npm run deploy</code> script.</p>

<h3 id="data-sources">Data Sources</h3>

<ul>
  <li>Mapbox
    <ul>
      <li>basemap and ortho for one of our apps</li>
    </ul>
  </li>
  <li>311.coz.org/data
    <ul>
      <li>all vector data is derived from the database, updated nightly</li>
      <li>raster data is created from either QGIS or ArcMap/Pro and copied over manually</li>
    </ul>
  </li>
</ul>

<h3 id="scripts">Scripts</h3>

<p>See the package.json in the project folder.</p>

<h3 id="potential-upgrades">Potential Upgrades</h3>
<p>Multi-Select on features
Imagery Historic Slider
Attribute Table w/Export
Area select and export of utility features</p>
:ET